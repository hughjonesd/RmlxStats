<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Strategy 2: Final Profile Report • RmlxStats</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Strategy 2: Final Profile Report"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">RmlxStats</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/benchmarks.html">Benchmarks</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hughjonesd/RmlxStats/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Strategy 2: Final Profile Report</h1>
      <small class="dont-index">Source: <a href="https://github.com/hughjonesd/RmlxStats/blob/HEAD/STRATEGY2_FINAL_PROFILE.md" class="external-link"><code>STRATEGY2_FINAL_PROFILE.md</code></a></small>
    </div>

<div id="strategy-2-final-profile-report" class="section level1">

<div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a></h2>
<p>Strategy 2 optimizations achieved a <strong>1.35x speedup</strong> in the optimized code path, plus fixed a <strong>critical crash bug</strong> with nlambda=100. However, additional bug fixes for the scaling code have restored some overhead, resulting in final performance approximately equal to the baseline.</p>
</div>
<div class="section level2">
<h2 id="current-performance-after-all-bug-fixes">Current Performance (After All Bug Fixes)<a class="anchor" aria-label="anchor" href="#current-performance-after-all-bug-fixes"></a></h2>
<div class="section level3">
<h3 id="benchmark-configuration">Benchmark Configuration<a class="anchor" aria-label="anchor" href="#benchmark-configuration"></a></h3>
<ul><li>n = 5000, p = 200, nlambda = 100</li>
<li>Gaussian family, lasso (alpha = 1)</li>
<li>standardize = TRUE</li>
</ul></div>
<div class="section level3">
<h3 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a></h3>
<pre><code>Package         Time      Ratio vs glmnet
----------------------------------------
glmnet          0.032s    1.00x (baseline)
mlxs_glmnet     1.169s    36.5x slower</code></pre>
</div>
<div class="section level3">
<h3 id="comparison-across-problem-sizes">Comparison Across Problem Sizes<a class="anchor" aria-label="anchor" href="#comparison-across-problem-sizes"></a></h3>
<pre><code>Config             n      p   nlambda  glmnet   mlxs    Ratio
---------------------------------------------------------------
target          5000    200      100   0.031s  1.191s   38.4x
target_small    5000    200       20   0.030s  0.248s    8.3x
large1         10000    100       50   0.016s  0.491s   30.7x
large2          8000    150       50   0.026s  0.494s   19.0x
---------------------------------------------------------------
Average ratio: 24.1x slower than glmnet</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="strategy-2-optimizations-applied">Strategy 2 Optimizations Applied<a class="anchor" aria-label="anchor" href="#strategy-2-optimizations-applied"></a></h2>
<div class="section level3">
<h3 id="id_1-early-mlx-conversion-lines-59-60">1. Early MLX Conversion (Lines 59-60)<a class="anchor" aria-label="anchor" href="#id_1-early-mlx-conversion-lines-59-60"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_mlx</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/as_mlx.html" class="external-link">as_mlx</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">y_mlx</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/mlx_reshape.html" class="external-link">mlx_reshape</a></span><span class="op">(</span><span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/as_mlx.html" class="external-link">as_mlx</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Code clarity improved, minimal performance change</p>
</div>
<div class="section level3">
<h3 id="id_2-keep-data-in-mlx-throughout-lines-105-108">2. Keep Data in MLX Throughout (Lines 105-108)<a class="anchor" aria-label="anchor" href="#id_2-keep-data-in-mlx-throughout-lines-105-108"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_store_mlx</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/mlx_zeros.html" class="external-link">mlx_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_pred</span>, <span class="va">n_lambda</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">intercept_store_mlx</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/mlx_zeros.html" class="external-link">mlx_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_lambda</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Eliminated 20k-50k conversions, but overhead was not the bottleneck</p>
</div>
<div class="section level3">
<h3 id="id_3-compiled-inner-loop-lines-122-168">3. Compiled Inner Loop (Lines 122-168)<a class="anchor" aria-label="anchor" href="#id_3-compiled-inner-loop-lines-122-168"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iter_func</span> <span class="op">&lt;-</span> <span class="fu">.get_compiled_iteration</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">iter_func</span><span class="op">(</span><span class="va">x_active</span>, <span class="va">beta_prev_subset</span>, <span class="va">residual_mlx</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: 1.22-1.35x speedup on the hot path</p>
</div>
<div class="section level3">
<h3 id="id_4-reshaped-scale-vectors-lines-64-69">4. Reshaped Scale Vectors (Lines 64-69)<a class="anchor" aria-label="anchor" href="#id_4-reshaped-scale-vectors-lines-64-69"></a></h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_center</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/mlx_reshape.html" class="external-link">mlx_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x_std_mlx</span>, <span class="st">"scaled:center"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_pred</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_scale</span> <span class="op">&lt;-</span> <span class="fu">Rmlx</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/Rmlx/reference/mlx_reshape.html" class="external-link">mlx_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x_std_mlx</span>, <span class="st">"scaled:scale"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_pred</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Eliminated reshape operations during unscaling</p>
</div>
</div>
<div class="section level2">
<h2 id="bug-fixes-in-this-release">Bug Fixes in This Release<a class="anchor" aria-label="anchor" href="#bug-fixes-in-this-release"></a></h2>
<div class="section level3">
<h3 id="id_1-scaling-variable-names-lines-194-197">1. Scaling Variable Names (Lines 194-197)<a class="anchor" aria-label="anchor" href="#id_1-scaling-variable-names-lines-194-197"></a></h3>
<p><strong>Problem</strong>: Used <code>beta_store</code> instead of <code>beta_store_mlx</code> <strong>Fix</strong>: Corrected variable references <strong>Impact</strong>: Restored correct scaling behavior</p>
</div>
<div class="section level3">
<h3 id="id_2-browser-debug-call-line-193">2. Browser() Debug Call (Line 193)<a class="anchor" aria-label="anchor" href="#id_2-browser-debug-call-line-193"></a></h3>
<p><strong>Problem</strong>: Left debugging statement in production code <strong>Fix</strong>: Removed <code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> call <strong>Impact</strong>: Eliminated interactive debugger interruption</p>
</div>
<div class="section level3">
<h3 id="id_3-missing-namespace-prefixes-lines-68-69">3. Missing Namespace Prefixes (Lines 68-69)<a class="anchor" aria-label="anchor" href="#id_3-missing-namespace-prefixes-lines-68-69"></a></h3>
<p><strong>Problem</strong>: <code>mlx_zeros()</code> and <code>mlx_ones()</code> missing <code>Rmlx::</code> prefix <strong>Fix</strong>: Added proper namespace qualification <strong>Impact</strong>: Fixed crash when standardize=FALSE</p>
</div>
<div class="section level3">
<h3 id="id_4-shape-broadcasting-lines-64-65-68-69">4. Shape Broadcasting (Lines 64-65, 68-69)<a class="anchor" aria-label="anchor" href="#id_4-shape-broadcasting-lines-64-65-68-69"></a></h3>
<p><strong>Problem</strong>: x_center and x_scale had wrong shapes for broadcasting <strong>Fix</strong>: Reshape to column vectors (n_pred, 1) from the start <strong>Impact</strong>: Eliminated reshape overhead during unscaling</p>
</div>
</div>
<div class="section level2">
<h2 id="performance-impact-of-bug-fixes">Performance Impact of Bug Fixes<a class="anchor" aria-label="anchor" href="#performance-impact-of-bug-fixes"></a></h2>
<p>The bug fixes, particularly the scaling corrections, have added necessary overhead:</p>
<pre><code>Version                          Time      vs Baseline
-----------------------------------------------------
Baseline (before Strategy 2)    1.181s    1.00x
Strategy 2 (with bugs)          0.740s    0.63x (1.59x faster)
Strategy 2 (bugs fixed)         1.169s    0.99x (no change)</code></pre>
<p><strong>Analysis</strong>: The “speedup” in the buggy version came from incorrectly skipping scaling operations. With correct scaling restored, performance returns to baseline levels. The compiled inner loop speedup (1.35x) is real but offset by other necessary operations.</p>
</div>
<div class="section level2">
<h2 id="why-still-36x-slower-than-glmnet">Why Still 36x Slower Than glmnet?<a class="anchor" aria-label="anchor" href="#why-still-36x-slower-than-glmnet"></a></h2>
<div class="section level3">
<h3 id="id_1-algorithm-difference">1. Algorithm Difference<a class="anchor" aria-label="anchor" href="#id_1-algorithm-difference"></a></h3>
<ul><li>
<strong>glmnet</strong>: Coordinate descent (optimal for lasso)</li>
<li>
<strong>mlxs_glmnet</strong>: Proximal gradient descent</li>
<li>
<strong>Impact</strong>: 3-5x more iterations needed</li>
</ul></div>
<div class="section level3">
<h3 id="id_2-language--implementation">2. Language &amp; Implementation<a class="anchor" aria-label="anchor" href="#id_2-language--implementation"></a></h3>
<ul><li>
<strong>glmnet</strong>: Highly optimized Fortran</li>
<li>
<strong>mlxs_glmnet</strong>: R + MLX with graph construction overhead</li>
<li>
<strong>Impact</strong>: Each operation has MLX dispatch cost</li>
</ul></div>
<div class="section level3">
<h3 id="id_3-parallelization">3. Parallelization<a class="anchor" aria-label="anchor" href="#id_3-parallelization"></a></h3>
<ul><li>
<strong>glmnet</strong>: Optimized sequential CPU loops</li>
<li>
<strong>mlxs_glmnet</strong>: MLX operations but sequential algorithm</li>
<li>
<strong>Impact</strong>: Cannot leverage GPU parallelism</li>
</ul></div>
<div class="section level3">
<h3 id="id_4-maturity">4. Maturity<a class="anchor" aria-label="anchor" href="#id_4-maturity"></a></h3>
<ul><li>
<strong>glmnet</strong>: Decades of optimization (2010-2024)</li>
<li>
<strong>mlxs_glmnet</strong>: New implementation (2024)</li>
<li>
<strong>Impact</strong>: Missing many optimizations</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="what-strategy-2-achieved">What Strategy 2 Achieved<a class="anchor" aria-label="anchor" href="#what-strategy-2-achieved"></a></h2>
<div class="section level3">
<h3 id="white_check_mark-successes">✅ Successes<a class="anchor" aria-label="anchor" href="#white_check_mark-successes"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Bug fix</strong>: Eliminated crash with nlambda=100</li>
<li>
<strong>Code quality</strong>: Cleaner MLX-native implementation</li>
<li>
<strong>Compilation</strong>: Demonstrated effective use of mlx_compile()</li>
<li>
<strong>Tests</strong>: Added coverage for standardize=FALSE</li>
<li>
<strong>Documentation</strong>: Comprehensive analysis of MLX performance</li>
</ol></div>
<div class="section level3">
<h3 id="x-performance-limitations">❌ Performance Limitations<a class="anchor" aria-label="anchor" href="#x-performance-limitations"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Still 36x slower</strong>: Fundamental algorithm limitations</li>
<li>
<strong>No GPU benefit</strong>: Sequential operations don’t parallelize</li>
<li>
<strong>Conversion overhead minimal</strong>: Eliminating conversions didn’t help</li>
</ol></div>
</div>
<div class="section level2">
<h2 id="test-coverage">Test Coverage<a class="anchor" aria-label="anchor" href="#test-coverage"></a></h2>
<p>All tests passing (6/6): - ✅ Gaussian lasso matches glmnet (standardize=TRUE) - ✅ Binomial lasso matches glmnet (standardize=TRUE) - ✅ Gaussian lasso with standardize=FALSE - ✅ Shape preservation - ✅ Lambda sequence handling - ✅ Intercept and coefficient accuracy</p>
</div>
<div class="section level2">
<h2 id="recommendations">Recommendations<a class="anchor" aria-label="anchor" href="#recommendations"></a></h2>
<div class="section level3">
<h3 id="for-production-use">For Production Use<a class="anchor" aria-label="anchor" href="#for-production-use"></a></h3>
<p><strong>Merge this version</strong> because: - Critical bugs fixed (standardize=FALSE works, no crashes) - All tests passing - Code is cleaner and more maintainable - Demonstrates proper MLX patterns</p>
</div>
<div class="section level3">
<h3 id="for-performance-improvements">For Performance Improvements<a class="anchor" aria-label="anchor" href="#for-performance-improvements"></a></h3>
<p><strong>Strategy 2 has reached its ceiling.</strong> To match glmnet performance:</p>
<ol style="list-style-type: decimal"><li>
<strong>Strategy 1: Coordinate Descent in MLX</strong>
<ul><li>Implement coordinate updates natively</li>
<li>Parallelize across coordinates</li>
<li>Expected: 10-50x speedup</li>
</ul></li>
<li>
<strong>Quick Wins Available</strong>
<ul><li>Multi-lambda batching (process λ values in parallel)</li>
<li>FISTA acceleration (faster convergence)</li>
<li>Better strong rules (more aggressive screening)</li>
</ul></li>
<li>
<strong>Accept Current Performance</strong>
<ul><li>36x slower is acceptable for:
<ul><li>Small/medium problems (&lt; 1s runtime)</li>
<li>Educational/research use</li>
<li>Testing MLX capabilities</li>
</ul></li>
<li>Use glmnet for production large-scale problems</li>
</ul></li>
</ol></div>
</div>
<div class="section level2">
<h2 id="key-insights-from-strategy-2">Key Insights from Strategy 2<a class="anchor" aria-label="anchor" href="#key-insights-from-strategy-2"></a></h2>
<div class="section level3">
<h3 id="what-we-learned">What We Learned<a class="anchor" aria-label="anchor" href="#what-we-learned"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Conversion overhead is small</strong>: Eliminating 20k-50k conversions had minimal impact</li>
<li>
<strong>Compilation helps</strong>: Real 1.22-1.35x speedup on hot paths</li>
<li>
<strong>Algorithm matters most</strong>: Choice of algorithm dominates all other factors</li>
<li>
<strong>Correctness is paramount</strong>: Bug fixes are more valuable than buggy speedups</li>
</ol></div>
<div class="section level3">
<h3 id="mlx-performance-patterns">MLX Performance Patterns<a class="anchor" aria-label="anchor" href="#mlx-performance-patterns"></a></h3>
<ol style="list-style-type: decimal"><li>Keep data in MLX throughout computation</li>
<li>Use mlx_compile() for hot inner loops</li>
<li>Avoid unnecessary R↔︎MLX conversions (but don’t over-optimize)</li>
<li>Reshape data to correct dimensions upfront</li>
<li>Algorithm design &gt;&gt; micro-optimizations</li>
</ol></div>
</div>
<div class="section level2">
<h2 id="files-in-this-release">Files in This Release<a class="anchor" aria-label="anchor" href="#files-in-this-release"></a></h2>
<p>Modified: - <code>R/mlxs-glmnet.R</code> - Bug fixes and Strategy 2 optimizations - <code>tests/testthat/test-mlxs-glmnet.R</code> - Added standardize=FALSE test</p>
<p>Documentation: - <code>STRATEGY2_COMPLETE.md</code> - Original Strategy 2 results - <code>STRATEGY2_FINAL_PROFILE.md</code> - This document - <code>COMPILATION_INVESTIGATION.md</code> - How mlx_compile works - <code>MLX_CONVERSION_INVESTIGATION.md</code> - Conversion overhead analysis - <code>AGENTS.md</code> - MLX performance guidance</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a></h2>
<p>Strategy 2 successfully improved code quality and fixed critical bugs, but did not achieve significant performance gains over the baseline once bugs were properly fixed. The fundamental limitation is algorithmic: proximal gradient descent cannot compete with coordinate descent for lasso problems.</p>
<p><strong>Bottom line</strong>: This is a solid, correct implementation suitable for production use on small-to-medium problems. For performance parity with glmnet, coordinate descent (Strategy 1) is required.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Hugh-Jones.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

